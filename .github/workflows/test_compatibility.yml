name: CADET version compatibility

on:
  workflow_dispatch:
    inputs:
      cadet_core_version:
        description: "cadet-core version to install from pip. If empty read from toml; if toml missing use latest"
        required: false
        default: ""
      cadet_process_ref:
        description: "cadet-process git ref (branch/tag/sha). If empty read from toml; if toml missing use latest release tag"
        required: false
        default: ""

  workflow_call:
    inputs:
      cadet_core_version:
        description: "cadet-core version to install from pip. If empty read from toml; if toml missing use latest"
        required: false
        type: string
        default: ""
      cadet_process_ref:
        description: "cadet-process git ref (branch/tag/sha). If empty read from toml; if toml missing use latest release tag"
        required: false
        type: string
        default: ""

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.12", "3.13"]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Upgrade packaging tools
        shell: bash
        run: |
          set -euxo pipefail
          python -m pip install -U pip setuptools wheel packaging

      - name: Read expected CADET versions from pyproject.toml
        id: toml_expected
        shell: bash
        run: |
          set -euxo pipefail
          python - <<'PY'
          import re
          from pathlib import Path
          import tomllib
          from packaging.specifiers import SpecifierSet

          pyproject = Path("pyproject.toml")
          out = Path(__import__("os").environ["GITHUB_OUTPUT"])

          def write(k, v):
              out.write_text(out.read_text(encoding="utf-8") + f"{k}={v}\n" if out.exists() else f"{k}={v}\n", encoding="utf-8")

          def normalize_req(req: str) -> str:
              # Allow "pkg=1.2.3" and "pkg==1.2.3"
              # Replace a single "=" (not part of <= >= == != ~=) with "=="
              req = req.strip()
              req = re.sub(r"(?<![<>=!~])=(?!=)", "==", req)
              return req

          def find_dep(deps, name):
              for d in deps:
                  if isinstance(d, str) and d.lower().startswith(name.lower()):
                      return normalize_req(d)
              return ""

          def extract_spec(req: str, name: str) -> str:
              # Drop extras and environment markers
              main = req.split(";", 1)[0].strip()
              # Remove "name" and optional extras part
              main = re.sub(rf"^{re.escape(name)}(\[[^\]]+\])?\s*", "", main, flags=re.IGNORECASE).strip()
              # If nothing left, no constraint
              return main

          expected_core_spec = ""
          expected_proc_spec = ""
          expected_core_pinned = ""
          expected_proc_pinned = ""

          if not pyproject.exists():
              write("EXPECTED_CORE_SPEC", "")
              write("EXPECTED_PROC_SPEC", "")
              write("EXPECTED_CORE_PINNED", "")
              write("EXPECTED_PROC_PINNED", "")
              print("pyproject.toml not found, no expected versions available")
              raise SystemExit(0)

          data = tomllib.loads(pyproject.read_text(encoding="utf-8"))
          proj = data.get("project", {}) or {}

          deps = []
          deps.extend(proj.get("dependencies", []) or [])
          opt = proj.get("optional-dependencies", {}) or {}
          for group in ("testing", "test", "dev", "all"):
              deps.extend(opt.get(group, []) or [])

          core_req = find_dep(deps, "cadet-core")
          proc_req = find_dep(deps, "cadet-process")

          if core_req:
              core_spec_str = extract_spec(core_req, "cadet-core")
              expected_core_spec = core_spec_str
              spec = SpecifierSet(core_spec_str) if core_spec_str else SpecifierSet()
              pinned = [s for s in spec if str(s).startswith("==")]
              expected_core_pinned = pinned[0].version if len(pinned) == 1 and len(list(spec)) == 1 else ""
          if proc_req:
              proc_spec_str = extract_spec(proc_req, "cadet-process")
              expected_proc_spec = proc_spec_str
              spec = SpecifierSet(proc_spec_str) if proc_spec_str else SpecifierSet()
              pinned = [s for s in spec if str(s).startswith("==")]
              expected_proc_pinned = pinned[0].version if len(pinned) == 1 and len(list(spec)) == 1 else ""

          write("EXPECTED_CORE_SPEC", expected_core_spec)
          write("EXPECTED_PROC_SPEC", expected_proc_spec)
          write("EXPECTED_CORE_PINNED", expected_core_pinned)
          write("EXPECTED_PROC_PINNED", expected_proc_pinned)

          print("Expected (toml) cadet-core spec   :", expected_core_spec or "<none>")
          print("Expected (toml) cadet-core pinned :", expected_core_pinned or "<not pinned>")
          print("Expected (toml) cadet-process spec   :", expected_proc_spec or "<none>")
          print("Expected (toml) cadet-process pinned :", expected_proc_pinned or "<not pinned>")
          PY

      - name: Resolve cadet-process ref (input > toml pinned > latest release)
        id: resolve_proc_ref
        uses: actions/github-script@v7
        with:
          script: |
            const inputRef = (process.env.INPUT_REF || "").trim();
            const tomlPinned = (process.env.TOML_PINNED || "").trim();

            if (inputRef) {
              core.setOutput("ref", inputRef);
              core.info(`Using provided CADET-Process ref: ${inputRef}`);
              return;
            }

            if (tomlPinned) {
              // If your tags are not prefixed with "v", change this line accordingly.
              const tag = `v${tomlPinned}`;
              core.setOutput("ref", tag);
              core.info(`Using CADET-Process tag from toml pinned version: ${tag}`);
              return;
            }

            const owner = "fau-advanced-separations";
            const repo = "CADET-Process";
            const rel = await github.rest.repos.getLatestRelease({ owner, repo });
            const tag = rel.data.tag_name;
            core.setOutput("ref", tag);
            core.info(`Resolved latest CADET-Process release tag: ${tag}`);
        env:
          INPUT_REF: ${{ inputs.cadet_process_ref }}
          TOML_PINNED: ${{ steps.toml_expected.outputs.EXPECTED_PROC_PINNED }}

      - name: Checkout cadet-process
        uses: actions/checkout@v4
        with:
          repository: fau-advanced-separations/CADET-Process
          ref: ${{ steps.resolve_proc_ref.outputs.ref }}
          path: cadet-process

      - name: Crosscheck provided/ref versions against toml expectations (always)
        shell: bash
        run: |
          set -euxo pipefail
          python - <<'PY'
          import os, re
          from packaging.version import Version
          from packaging.specifiers import SpecifierSet

          def warn(msg):
              print(f"::warning::{msg}")

          input_core = os.environ.get("INPUT_CORE", "").strip()
          input_ref  = os.environ.get("INPUT_REF", "").strip()

          resolved_ref = os.environ["RESOLVED_REF"].strip()

          exp_core_spec = os.environ.get("EXP_CORE_SPEC", "").strip()
          exp_proc_spec = os.environ.get("EXP_PROC_SPEC", "").strip()

          print("Input cadet-core version         :", input_core or "<empty>")
          print("Input cadet-process ref          :", input_ref or "<empty>")
          print("Resolved cadet-process ref       :", resolved_ref)
          print("Expected (toml) cadet-core spec  :", exp_core_spec or "<none>")
          print("Expected (toml) cadet-process spec:", exp_proc_spec or "<none>")

          # If user provided inputs, always warn with input and expected (per your request).
          if input_core and exp_core_spec:
              warn(f"cadet-core requested '{input_core}', toml expects '{exp_core_spec}'")
          if input_ref and exp_proc_spec:
              warn(f"cadet-process requested ref '{input_ref}', toml expects '{exp_proc_spec}'")

          # Check resolved cadet-process ref if it looks like a version tag.
          m = re.match(r"^v?(\d+(?:\.\d+){1,3}.*)$", resolved_ref)
          if m and exp_proc_spec:
              resolved_ver = Version(m.group(1))
              spec = SpecifierSet(exp_proc_spec) if exp_proc_spec else SpecifierSet()
              if spec and resolved_ver not in spec:
                  warn(
                      f"CADET-Process mismatch: resolved '{resolved_ref}' (version {resolved_ver}) "
                      f"does not satisfy toml '{exp_proc_spec}'"
                  )
          elif exp_proc_spec:
              warn(f"Resolved CADET-Process ref '{resolved_ref}' is not a version tag; cannot compare to toml '{exp_proc_spec}'")

          # Check input cadet-core version if provided and toml has a spec.
          if input_core and exp_core_spec:
              try:
                  v = Version(input_core)
                  spec = SpecifierSet(exp_core_spec) if exp_core_spec else SpecifierSet()
                  if spec and v not in spec:
                      warn(f"cadet-core mismatch: requested {v} does not satisfy toml '{exp_core_spec}'")
              except Exception:
                  warn(f"cadet-core requested '{input_core}' is not a PEP 440 version; cannot compare to toml '{exp_core_spec}'")
          PY
        env:
          INPUT_CORE: ${{ inputs.cadet_core_version }}
          INPUT_REF: ${{ inputs.cadet_process_ref }}
          RESOLVED_REF: ${{ steps.resolve_proc_ref.outputs.ref }}
          EXP_CORE_SPEC: ${{ steps.toml_expected.outputs.EXPECTED_CORE_SPEC }}
          EXP_PROC_SPEC: ${{ steps.toml_expected.outputs.EXPECTED_PROC_SPEC }}

      - name: Install cadet-core and cadet-process
        shell: bash
        run: |
          set -euxo pipefail

          # cadet-core install rule: input > toml pinned > latest
          if [ -n "${{ inputs.cadet_core_version }}" ]; then
            python -m pip install "cadet-core==${{ inputs.cadet_core_version }}"
          elif [ -n "${{ steps.toml_expected.outputs.EXPECTED_CORE_PINNED }}" ]; then
            python -m pip install "cadet-core==${{ steps.toml_expected.outputs.EXPECTED_CORE_PINNED }}"
          else
            python -m pip install cadet-core
          fi

          cd cadet-process
          python -m pip install -e ".[testing]" || python -m pip install -e "."
          python -m pip install -U pytest

      - name: Put cadet_core/bin on PATH (bundled binaries/DLLs)
        shell: bash
        run: |
          set -euxo pipefail
          python - <<'PY'
          import os
          from pathlib import Path
          import cadet_core

          bindir = Path(cadet_core.__file__).resolve().parent / "bin"
          print("cadet_core bin dir:", bindir)

          with open(os.environ["GITHUB_PATH"], "a", encoding="utf-8") as f:
            f.write(str(bindir) + "\n")
          PY

      - name: Windows dependency inspection (dumpbin)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Windows show CADET dependencies (dumpbin)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $exe = python -c "import cadet_core; print(cadet_core.get_cadet_binary())"
          Write-Host "EXE: $exe"
          dumpbin /DEPENDENTS $exe

      - name: Report CADET versions and verify cadet-cli
        shell: bash
        run: |
          set -euxo pipefail
          python - <<'PY'
          import os
          import subprocess
          from pathlib import Path

          def pkg_version(name):
            try:
              import importlib.metadata as im
              return im.version(name)
            except Exception:
              return "not installed"

          print("\nInstalled Python packages:")
          print("cadet-core    :", pkg_version("cadet-core"))
          print("cadet-python  :", pkg_version("cadet-python"))
          print("cadet-process :", pkg_version("cadet-process"))

          import cadet_core
          exe = Path(cadet_core.get_cadet_binary())
          bindir = exe.parent

          env = os.environ.copy()
          env["PATH"] = str(bindir) + os.pathsep + env.get("PATH", "")
          subprocess.check_call([str(exe), "--version"], env=env)
          PY

      - name: Run pytest
        shell: bash
        env:
          MPLBACKEND: Agg
        run: |
          set -euxo pipefail
          cd cadet-process
          python -m pytest tests -m "not slow" --durations=0
